<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bull & Cows</title>
    <style>
        body, input {
            font-family: 'Courier New', Courier, monospace;
            font-size: 32pt;
        }
        input {
            width: 100%;
            box-sizing: border-box;
            display: inline-block;
        }
        input[type=tel] {
            letter-spacing: 0.5em;
            padding: 1px 0;
        }
        del {
            opacity: 50%;
        }
        #text_number, #button_check, #button_show {
            width: 50%;
            margin: 0;
        }
        #number {
            font-weight: bold;
            display: inline-block;
            width: 50%;
        }
        #number, #history {
            letter-spacing: 0.5em;
            margin-bottom: 0.5em;
        }
        #container {
            width: 10em;
            margin: 3em auto;
        }
    </style>
</head>

<body>
    <div id="container">
        <div><span id="number">****</span><input id="button_show" type="button" value="Show" /></div>
        <div id="history"></div>
        <div>
            <form id="form" autocomplete="off">
                <input id="text_number" type="tel" maxlength="4" autocomplete="false" /><input id="button_check" type="submit" value="Check" />
                <input id="button_hint" type="button" value="Hint" />
                <input id="button_new" type="button" value="New Game" />
            </form>
        </div>
    </div>
</body>

<!-- Scripts -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R5GY57D036"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag () { dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'G-R5GY57D036');
</script>
<script>
(function () {

var Game = function () {
    this.chars = '123456789';
    this.length = 4;
    this.number = null;
    this.history = [];
    this.valid_numbers = [];
    this._generate('', this.valid_numbers);
    this.init();
};

Game.prototype._generate = function (prefix, items) {
    if (prefix.length === this.length) {
        items.push(prefix);
    } else {
        for (var i = 0; i < this.chars.length; i++) {
            var c = this.chars[i];
            if (!prefix.includes(c)) {
                this._generate(prefix + c, items);
            }
        }
    }
};

Game.prototype.init = function () {
    this.history = [];
    this.number = this.valid_numbers[Math.floor(Math.random() * this.valid_numbers.length)];
};

Game.prototype.check = function (number) {
    var result = this._check(number, this.number);
    if (result.ok) {
        this.history.push(number);
    }
    return result;
};

Game.prototype._check = function (number, origin) {
    if (!this.valid_numbers.includes(number)) {
        return {
            'ok': false,
            'error': 'Number should have 4 unique digits'
        };
    }
    var bulls = 0;
    var cows = 0;
    for (var i = 0; i < origin.length; i++) {
        for (var j = 0; j < number.length; j++) {
            var a = origin[i];
            var b = number[j];
            if (a === b) {
                if (i === j) {
                    bulls++;
                } else {
                    cows++;
                }
            }
        }
    }
    return {
        'ok': true,
        'number': number,
        'bulls': bulls,
        'cows': cows,
        'win': bulls === this.length
    }
};

Game.prototype.hint = function () {
    var x = null;
    var valid = false;
    for (var i = 0; i < this.valid_numbers.length; i++) {
        x = this.valid_numbers[i];
        valid = true;
        for (var h = 0; h < this.history.length; h++) {
            var origin_result = this._check(this.history[h], this.number);
            var x_result = this._check(this.history[h], x);
            if (JSON.stringify(origin_result) === JSON.stringify(x_result)) {
                continue;
            } else {
                valid = false;
                break;
            }
        }
        if (valid) break;
    }
    return x;
};

function gid(id) { return document.getElementById(id); }

var View = function () {
    this.game = new Game();
    this.history = [];
    this.in_game = false;
    var self = this;
    gid('button_show').onclick = function () { self.onShow(); };
    gid('button_hint').onclick = function () { self.onHint(); };
    gid('button_new').onclick = function () { self.onNew(); }
    gid('form').onsubmit = function (e) {
        e.preventDefault();
        self.onCheck();
        return false;
    };
    this.init();
    this.update_view();
};

View.prototype.init = function () {
    this.game.init();
    this.history = [];
    this.in_game = true;
    gid('text_number').value = this.game.hint();

    gtag('event', 'game_started');
};

View.prototype.update_view = function () {
    var self = this;
    gid('number').innerHTML = this.in_game ? '*'.repeat(this.game.length) : this.game.number;
    gid('button_show').style = this.in_game ? 'display: inline-block' : 'display: none';
    gid('button_hint').style = this.in_game ? 'display: inline-block' : 'display: none';
    gid('button_check').style = this.in_game ? 'display: inline-block' : 'display: none';
    gid('text_number').style = this.in_game ? 'display: inline-block' : 'display: none';
    gid('history').innerHTML = this.history.map(function (x) { return self.result2HTML(x); }).join('');
    if (this.in_game) { gid('text_number').focus(); }
};

View.prototype.result2HTML = function (result) {
    var number = result.number;
    var origin = this.game.number;
    var formatted_number = number;
    if (!this.in_game) {
        formatted_number = '';
        for (var i = 0; i < this.game.length; i++) {
            if (number[i] === origin[i]) {
                formatted_number += '<b>' + number[i] + '</b>';
            } else if (origin.includes(number[i])) {
                formatted_number += number[i];
            } else {
                formatted_number += '<del>' + number[i] + '</del>';
            }
        }
    }
    return '<div>' + formatted_number + ' ' + 'B'.repeat(result.bulls) + 'c'.repeat(result.cows) + '</div>';
};

View.prototype.onNew = function () {
    this.init();
    this.update_view();

    gtag('event', 'new_game');
};

View.prototype.onCheck = function () {
    var number = gid('text_number').value;
    var result = this.game.check(number);
    if (result.ok) {
        gid('text_number').value = '';
        this.history.push(result);
        gid('history').innerHTML += this.result2HTML(result);
        if (result.win) {
            this.in_game = false;
            this.update_view();

            gtag('event', 'win', { 'steps': this.history.length });
            gtag('event', 'game_finished');
        }
    } else {
        alert(result.error);
    }
    gid('text_number').focus();

    gtag('event', 'check_number');
};

View.prototype.onHint = function () {
    gid('text_number').value = this.game.hint();
    gid('text_number').focus();
    
    gtag('event', 'use_hint');
};

View.prototype.onShow = function () {
    this.in_game = false;
    this.update_view();
    
    gtag('event', 'show_number', { 'steps': this.history.length });
    gtag('event', 'game_finished');
};

var view = new View();

})();
</script>

</html>
